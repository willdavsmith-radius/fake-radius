name: Publish Deployment Engine Image

on:
  workflow_dispatch:
  repository_dispatch:
    types: [deployment-engine.publish]

permissions:
  contents: read
  packages: write
  id-token: write

# variables from GitHub organization
  # ${{ vars.ACR_NAME }}

# secrets from GitHub organization
  # ${{ secrets.GH_APP_ID }}
  # ${{ secrets.GH_APP_PRIVATE_KEY }}
  # ${{ secrets.ACR_AZURE_CLIENT_ID }}
  # ${{ secrets.ACR_AZURE_TENANT_ID }}
  # ${{ secrets.ACR_AZURE_SUBSCRIPTION_ID }}

jobs:
  publish-image:
    runs-on: ubuntu-latest
    environment:
      name: publish-de-image

    steps:
      - name: Capture payload
        id: payload
        shell: bash
        env:
          IMAGE_NAME: ${{ github.event.client_payload.image_name || '' }}
          TAG: ${{ github.event.client_payload.tag || '' }}
        run: |
          echo "::set-output name=image-name::${IMAGE_NAME}"
          echo "::set-output name=tag::${TAG}"

      - name: Get GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repository: ${{ github.event.repository.name }}
          permissions: 'packages:write,contents:read'

      - name: Copy Deployment Engine image
        uses: ./.github/actions/copy-deployment-engine-image
        env:
          ACR_AZURE_CLIENT_ID: ${{ secrets.ACR_AZURE_CLIENT_ID }}
          ACR_AZURE_TENANT_ID: ${{ secrets.ACR_AZURE_TENANT_ID }}
          ACR_AZURE_SUBSCRIPTION_ID: ${{ secrets.ACR_AZURE_SUBSCRIPTION_ID }}
          GHCR_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          tag: ${{ steps.payload.outputs.tag }}
          acr-source-name: ${{ steps.payload.outputs.acr-name }}
          acr-source-repository: ${{ steps.payload.outputs.image-name }}
          ghcr-destination-repository: ${{ steps.payload.outputs.target-repo }}
